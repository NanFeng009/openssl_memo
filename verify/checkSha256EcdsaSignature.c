#include <stdio.h>
#include <openssl/evp.h>
#include <openssl/ec.h>
#include <openssl/bn.h>
#include <openssl/err.h>

/*
 * TDX
 * xxd -ps -s 0x302 -l0x180 -i quote.dat
 * xxd -ps -s 0x482 -l0x40 -i quote.dat
 
 * SGX
 ** qe3_report_sig
 * sig: xxd -ps -s 0x3b4 -l0x40 -i quote.dat
 ** sgx_report_body_qe3_t
 * msg: xxd -ps -s 0x234 -l0x180 -i quote.dat
 *
 *cat key.dat
  0xb8,0xe0,0xf0,0x52,0x5b,0x35,0xbc,0x41,0x41,0x81,0xf2,0xfc,0xe5,0xc6,
  0x5b,0xf8,0x6c,0x30,0x04,0x4f,0x9f,0x1a,0x6f,0x75,0xba,0x1e,0x06,0x0c,
  0x0e,0x43,0xda,0xd3,0xb5,0x99,0x61,0x70,0x08,0x6d,0x24,0xf8,0x6f,0xe6,
  0xec,0x20,0x9a,0xcb,0x7b,0x43,0x5d,0x00,0xfb,0xfa,0x09,0x12,0x45,0x5a,
  0x45,0x71,0xdc,0x8a,0x04,0x61,0x44,0x80

cat msg.dat
  0x02, 0x02, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe7, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0xd8, 0x34, 0x1d, 0x4c, 0x6e, 0x86, 0x92, 0x54,
  0x48, 0xdc, 0x8e, 0xa2, 0x67, 0x2b, 0x98, 0xaf, 0x4a, 0x88, 0x90, 0x6e,
  0xae, 0x18, 0x29, 0x54, 0x3d, 0x4b, 0x3c, 0x32, 0xea, 0xf5, 0x64, 0x59,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe4, 0xbd, 0x9f, 0xc2,
  0x12, 0x98, 0x35, 0xba, 0x1d, 0xcc, 0xa1, 0x93, 0x9d, 0x57, 0xd0, 0x8e,
  0x88, 0x56, 0x1b, 0x34, 0x74, 0x0d, 0x59, 0x40, 0x59, 0x72, 0xd4, 0xba,
  0x25, 0xa7, 0xe5, 0xf7, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x37, 0xed, 0x62, 0xb6,
  0x89, 0x80, 0xc6, 0xbd, 0x9b, 0x12, 0x4b, 0xef, 0x97, 0x2f, 0xb6, 0x40,
  0x94, 0x07, 0xe5, 0x1e, 0x12, 0x8c, 0x7c, 0xd7, 0xfd, 0x3b, 0x83, 0x0d,
  0x69, 0x81, 0xd3, 0xdf, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
cat sig.dat
  0x08, 0xd9, 0xc4, 0xdc, 0x44, 0xba, 0x2a, 0xfb, 0xc0, 0x3c, 0x80, 0xab,
  0xd4, 0xe0, 0x56, 0x4a, 0xbe, 0x28, 0x5c, 0x5f, 0x27, 0x2b, 0xbb, 0x30,
  0x84, 0x69, 0xcc, 0xb7, 0x60, 0xd9, 0xfa, 0x43, 0x5f, 0xe1, 0x53, 0xa9,
  0x45, 0xb6, 0x9a, 0xdc, 0x27, 0x77, 0x26, 0x06, 0xcc, 0x8f, 0xe0, 0x42,
  0x6c, 0x85, 0xab, 0xf7, 0xd2, 0x32, 0x0d, 0x7a, 0x75, 0x37, 0xf7, 0x9f,
  0x57, 0x43, 0x0f, 0x0c
 */
int main()
{
		EVP_MD_CTX *ctx = NULL;
		EC_GROUP *group =NULL;
		EC_POINT *point = NULL;
		BIGNUM *bnX = NULL ;
		BIGNUM *bnY = NULL;
		BIGNUM *bnR = NULL;
		BIGNUM *bnS = NULL;
		EC_KEY *key = NULL;
		EVP_PKEY *evpKey = NULL;
		ECDSA_SIG * ecdsaSig = NULL;
		int res = 0;
		unsigned char *derSig = NULL;
		int derlen = -1;
		int expectedSize = -1;

		// from pck cert
		uint8_t rawKey[] = {
#include "key.dat"
		};	

		uint8_t sig[] = {
#include "sig.dat"
		};

		uint8_t msg[] = {
#include "msg.dat"
		};

		bnX = BN_new();
		bnY = BN_new();
		BN_bin2bn(rawKey, 32, bnX);
		BN_bin2bn(rawKey + 32, 32, bnY);

		group = EC_GROUP_new_by_curve_name(NID_X9_62_prime256v1);
		point = EC_POINT_new(group);

		if(1 != EC_POINT_set_affine_coordinates_GFp(group, point, bnX, bnY, NULL))
		{
				long e = ERR_get_error();
				printf("Error set coordinate %ld\n", e);
				printf("\t%s\n", ERR_reason_error_string(e));
				return -__LINE__;
		}

		key = EC_KEY_new_by_curve_name(NID_X9_62_prime256v1);
		if(1 != EC_KEY_set_public_key(key, point))
		{
				long e = ERR_get_error();
				printf("Error set pulbic key %ld\n", e);
				printf("\t%s\n", ERR_reason_error_string(e));
				return -__LINE__;
		}

		//convert EC_KEY to EVP_PKEY
		evpKey = EVP_PKEY_new();
		if(evpKey == NULL)
		{
				printf("error get EVP key\n");
				return -__LINE__;
		}

		res = EVP_PKEY_set1_EC_KEY(evpKey, key);
		if(res == 0)
		{
				printf("Error convert key\n");
				return -__LINE__;
		}

		// raw ecdsa signature to DER
		bnR = BN_new();
		bnS = BN_new();
		BN_bin2bn(sig, 32, bnR);
		BN_bin2bn(sig + 32, 32, bnS);
		ecdsaSig = ECDSA_SIG_new();
		res = ECDSA_SIG_set0(ecdsaSig, bnR, bnS);
		if(res != 1)
		{
				printf("Error setting signature\n");
				return -__LINE__;
		}
		expectedSize = i2d_ECDSA_SIG(ecdsaSig, NULL);
		if(expectedSize < 0)
		{
				printf("Error i2d get size %ld\n", ERR_get_error());
				return -__LINE__;
		}
		derlen  = i2d_ECDSA_SIG(ecdsaSig, &derSig);
		if(derlen != expectedSize)
		{
				printf("Error i2d convert %ld\n", ERR_get_error());
				return -__LINE__;
		}


		// clean the error queue
		ERR_clear_error();

		ctx = EVP_MD_CTX_new();
		res = EVP_DigestVerifyInit(ctx, NULL, EVP_sha256(), NULL, evpKey);
		if(res != 1)
		{
				printf("Error setting context\n");
				return -__LINE__;
		}
		res = EVP_DigestVerifyUpdate(ctx, msg, sizeof(msg));
		if(res != 1)
		{
				printf("Error updateing context\n");
				return -__LINE__;
		}
		res = EVP_DigestVerifyFinal(ctx, derSig, expectedSize);
		if (res > 0) {
				printf( "Verified OK\n");
		} else if (res == 0) {
				long e = ERR_get_error();
				printf( "Verification failure %ld\n", e);
				printf("\t%s\n", ERR_reason_error_string(e));
				return -__LINE__;
		} else {
				long e = ERR_get_error();
				printf("Error verifying data %ld\n", e);
				printf("\t%s\n", ERR_reason_error_string(e));
				return -__LINE__;
		}
		// clean up 
		OPENSSL_free(derSig);
		BN_free(bnX);
		BN_free(bnY);
		EC_KEY_free(key);
		// will be free in ECDSA_SIG_free
//		BN_free(bnR);
//		BN_free(bnS);
		EVP_MD_CTX_free(ctx);
		EVP_PKEY_free(evpKey);
		EC_POINT_free(point);
		ECDSA_SIG_free(ecdsaSig);
		EC_GROUP_free(group);

		return 0;



}
